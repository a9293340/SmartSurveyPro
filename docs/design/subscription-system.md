# è¨‚é–±ç³»çµ± - è¨­è¨ˆæ–‡ä»¶

> ğŸ“… æ–‡ä»¶ç‰ˆæœ¬ï¼šv1.1 ğŸ“ æœ€å¾Œæ›´æ–°ï¼š2025-01-16 ğŸ‘¥ è¨­è¨ˆåœ˜éšŠï¼šClaude + Human
> ğŸ¯ ç‹€æ…‹ï¼šè¨­è¨ˆéšæ®µ

## æ¦‚è¿°

SmartSurvey
Pro è¨‚é–±ç³»çµ±æ¡ç”¨æœˆä»˜åˆ¶ï¼Œçµåˆè‡ªç„¶æœˆè¨ˆç®—èˆ‡æ¯æ—¥é™é¡æ§åˆ¶ï¼Œç¢ºä¿æœå‹™å“è³ªèˆ‡ç”¨æˆ¶é«”é©—å¹³è¡¡ã€‚æ¸¬è©¦æœŸé–“é è¨­ Enterprise ç­‰ç´šï¼Œæ”¯æ´å‹•æ…‹èª¿æ•´ä¼æ¥­å®¢æˆ¶éœ€æ±‚ã€‚

## ğŸ”´ é‡è¦æ¶æ§‹åŸå‰‡

**è¨‚é–±ç¶å®šå°è±¡ï¼šGroupï¼ˆåœ˜éšŠï¼‰ï¼Œé Userï¼ˆå€‹äººï¼‰**

- âœ… **Group æ“æœ‰è¨‚é–±æ–¹æ¡ˆ**ï¼šæ¯å€‹ Group æœ‰è‡ªå·±çš„ planType å’Œä½¿ç”¨é™åˆ¶
- âœ… **User é€é Group ç¹¼æ‰¿æ¬Šé™**ï¼šUser åŠ å…¥ Group å¾Œå…±äº«è©² Group çš„è¨‚é–±æ¬Šç›Š
- âœ… **é™åˆ¶æª¢æŸ¥ä»¥ Group ç‚ºå–®ä½**ï¼šæª¢æŸ¥æ•´å€‹ Group çš„ç¸½ä½¿ç”¨é‡ï¼Œè€Œéå€‹äººä½¿ç”¨é‡
- âœ… **å¤š Group å ´æ™¯**ï¼šUser å¯åŠ å…¥å¤šå€‹ Groupï¼Œæ¯å€‹ Group æœ‰ç¨ç«‹çš„è¨‚é–±æ–¹æ¡ˆ

### æ¶æ§‹é‚è¼¯

```
User â”€â”
      â”œâ”€ belongs to â”€> Group â”€> has â”€> Subscription Plan
User â”€â”˜                              â””â”€> Usage Limits
```

### å¯¦éš›æ‡‰ç”¨å ´æ™¯

- **ä¼æ¥­ A çš„ Group**ï¼šEnterprise æ–¹æ¡ˆï¼Œç„¡é™å•å· + 1000 AI èª¿ç”¨/æ—¥
- **å€‹äºº User**ï¼šåŒæ™‚å±¬æ–¼ä¼æ¥­ A (Enterprise) å’Œæœ‹å‹çš„å°åœ˜éšŠ (Free)
- **é™åˆ¶æª¢æŸ¥**ï¼šåœ¨ä¼æ¥­ A çš„ Group ä¸­å¯ç„¡é™å»ºå•å·ï¼Œåœ¨æœ‹å‹ Group ä¸­åªèƒ½å»º 3 å€‹å•å·

## æ ¸å¿ƒè¨­è¨ˆåŸå‰‡

### 1. æœˆä»˜è‡ªç„¶æœˆåˆ¶

- **è¨ˆè²»é€±æœŸ**ï¼šæ¯è‡ªç„¶æœˆï¼ˆ1è™Ÿ-æœˆåº•ï¼‰
- **é‡ç½®æ™‚é–“**ï¼šå°åŒ—æ™‚é–“æ¯æ—¥ 00:00 é‡ç½®æ¯æ—¥é¡åº¦
- **ç°¡åŒ–é‚è¼¯**ï¼šé¿å…è¤‡é›œçš„æŒ‰æ—¥è¨ˆç®—ï¼Œé™ä½ç³»çµ±è¤‡é›œåº¦

### 2. æ¯æ—¥é™é¡æ§åˆ¶

- **ç›®çš„**ï¼šé˜²æ­¢ç”¨æˆ¶åœ¨æœˆåˆå¤§é‡æ¶ˆè€—è³‡æºï¼Œç¢ºä¿æ•´æœˆæœå‹™å“è³ª
- **è¶…é‡è™•ç†**ï¼šç›´æ¥é˜»æ“‹ï¼Œä¸æä¾›é™ç´šæœå‹™
- **ç”¨æˆ¶é«”é©—**ï¼šæ¸…æ¥šæç¤ºå‰©é¤˜é¡åº¦å’Œé‡ç½®æ™‚é–“

### 3. ä¼æ¥­ç´šå½ˆæ€§

- **æ¸¬è©¦é è¨­**ï¼šEnterprise ç­‰ç´šï¼Œç„¡éœ€é¡å¤–å»ºç«‹
- **å‹•æ…‹èª¿æ•´**ï¼šæ ¹æ“šä¼æ¥­éœ€æ±‚å³æ™‚èª¿æ•´é™é¡
- **æ“´å±•æ€§**ï¼šç‚ºæœªä¾†é™„åŠ æœå‹™é ç•™æ¶æ§‹ç©ºé–“

## è¨‚é–±æ–¹æ¡ˆè¨­è¨ˆ

### æ–¹æ¡ˆæ¶æ§‹

| æ–¹æ¡ˆ       | æœˆè²» | å•å·æ•¸é™åˆ¶ | æ¯æ—¥å•å·å»ºç«‹ | æœˆå›æ‡‰æ•¸ | æ¯æ—¥ AI èª¿ç”¨ | åœ˜éšŠæˆå“¡ |
| ---------- | ---- | ---------- | ------------ | -------- | ------------ | -------- |
| Free       | $0   | 3å€‹        | 1å€‹          | 100      | 5æ¬¡          | 1äºº      |
| Pro        | $29  | ç„¡é™       | 20å€‹         | 10,000   | 50æ¬¡         | 5äºº      |
| Team       | $99  | ç„¡é™       | 50å€‹         | 50,000   | 200æ¬¡        | 20äºº     |
| Enterprise | å®¢è£½ | ç„¡é™       | 100å€‹\*      | ç„¡é™\*   | 1000æ¬¡\*     | ç„¡é™\*   |

> \*Enterprise è¨­å®šé«˜ä¸Šé™ï¼Œå¯ä¾å®¢æˆ¶éœ€æ±‚å‹•æ…‹èª¿æ•´

### æ¯æ—¥é™é¡é‚è¼¯

```typescript
interface DailyLimits {
  surveysCreated: number; // æ¯æ—¥å¯å»ºç«‹å•å·æ•¸
  aiCallsUsed: number; // æ¯æ—¥ AI èª¿ç”¨æ¬¡æ•¸
  responsesCollected: number; // æ¯æ—¥å›æ‡‰æ”¶é›†æ•¸ï¼ˆEnterprise ç„¡é™ï¼‰
}

interface MonthlyLimits {
  totalSurveys: number; // ç¸½å•å·æ•¸é™åˆ¶
  totalResponses: number; // æœˆç¸½å›æ‡‰æ•¸
  teamMembers: number; // åœ˜éšŠæˆå“¡æ•¸
}
```

## ç³»çµ±æ¶æ§‹

### 1. è¨‚é–±ç‹€æ…‹ç®¡ç†ï¼ˆGroup-basedï¼‰

```typescript
enum SubscriptionStatus {
  ACTIVE = 'active', // æ­£å¸¸ä½¿ç”¨
  PAST_DUE = 'past_due', // é€¾æœŸæœªä»˜
  CANCELED = 'canceled', // å·²å–æ¶ˆ
  TRIALING = 'trialing', // è©¦ç”¨æœŸ
  INCOMPLETE = 'incomplete', // ä»˜æ¬¾ä¸å®Œæ•´
}

enum PlanType {
  FREE = 'free',
  PRO = 'pro',
  TEAM = 'team',
  ENTERPRISE = 'enterprise',
}

// ğŸ”´ é‡è¦ï¼šè¨‚é–±è³‡è¨Šç¶å®šåœ¨ Group ä¸Š
interface GroupSubscription {
  groupId: string;
  planType: PlanType;
  status: SubscriptionStatus;
  // ...å…¶ä»–è¨‚é–±æ¬„ä½
}
```

### 2. ä½¿ç”¨é‡è¿½è¹¤ç³»çµ±

```typescript
interface UsageTracking {
  userId: string;
  planType: PlanType;

  // æœˆåº¦çµ±è¨ˆ
  currentMonth: {
    surveysCreated: number;
    responsesReceived: number;
    aiCallsUsed: number;
    billingPeriodStart: Date;
    billingPeriodEnd: Date;
  };

  // æ¯æ—¥çµ±è¨ˆ
  dailyUsage: {
    date: string; // YYYY-MM-DD
    surveysCreated: number;
    aiCallsUsed: number;
    responsesReceived: number;
    resetAt: Date; // å°åŒ—æ™‚é–“ 00:00
  };

  // ç¸½è¨ˆ
  totalStats: {
    activeSurveys: number;
    totalResponses: number;
    teamMemberCount: number;
  };
}
```

### 3. é™é¡æª¢æŸ¥é‚è¼¯

```typescript
interface LimitCheckResult {
  allowed: boolean;
  reason?: string;
  remainingDaily?: number;
  remainingMonthly?: number;
  resetTime?: Date;
}

class SubscriptionService {
  async checkSurveyCreationLimit(userId: string): Promise<LimitCheckResult>;
  async checkAICallLimit(userId: string): Promise<LimitCheckResult>;
  async checkResponseLimit(userId: string): Promise<LimitCheckResult>;
  async resetDailyUsage(userId: string): Promise<void>;
}
```

## è³‡æ–™åº«è¨­è¨ˆ

### 1. Subscriptions Collection

```typescript
interface Subscription {
  _id: ObjectId;
  userId: ObjectId;
  planType: PlanType;
  status: SubscriptionStatus;

  // è¨ˆè²»è³‡è¨Š
  billing: {
    currentPeriodStart: Date;
    currentPeriodEnd: Date;
    nextBillingDate: Date;
    amount: number;
    currency: string;
  };

  // Enterprise å®¢è£½é…ç½®
  customLimits?: {
    dailySurveys?: number;
    dailyAICalls?: number;
    monthlyResponses?: number;
    teamMemberLimit?: number;
  };

  // å…ƒè³‡æ–™
  createdAt: Date;
  updatedAt: Date;
  canceledAt?: Date;
  trialEndsAt?: Date;
}
```

### 2. Usage Tracking Collection

```typescript
interface UsageRecord {
  _id: ObjectId;
  userId: ObjectId;
  planType: PlanType;

  // æ™‚é–“æ¨™è­˜
  month: string; // YYYY-MM
  date: string; // YYYY-MM-DD
  timezone: string; // Asia/Taipei

  // ä½¿ç”¨é‡çµ±è¨ˆ
  daily: {
    surveysCreated: number;
    aiCallsUsed: number;
    responsesReceived: number;
  };

  monthly: {
    totalSurveys: number;
    totalResponses: number;
    totalAICalls: number;
  };

  // ç´¢å¼•å„ªåŒ–
  createdAt: Date;
  updatedAt: Date;
}

// è¤‡åˆç´¢å¼•
// { userId: 1, date: 1 }
// { userId: 1, month: 1 }
```

## API è¨­è¨ˆ

### 1. è¨‚é–±ç®¡ç† API

```typescript
// GET /api/subscription/status
interface SubscriptionStatusResponse {
  planType: PlanType;
  status: SubscriptionStatus;
  limits: {
    daily: {
      surveys: { used: number; limit: number };
      aiCalls: { used: number; limit: number };
    };
    monthly: {
      responses: { used: number; limit: number };
      teamMembers: { used: number; limit: number };
    };
  };
  nextResetTime: Date;
  billingInfo: {
    nextBillingDate: Date;
    amount: number;
  };
}

// POST /api/subscription/upgrade
interface UpgradeRequest {
  targetPlan: PlanType;
  paymentMethodId?: string;
}

// POST /api/subscription/usage/check
interface UsageCheckRequest {
  action: 'create_survey' | 'ai_call' | 'collect_response';
}
```

### 2. ä½¿ç”¨é‡è¿½è¹¤ API

```typescript
// POST /api/usage/track
interface TrackUsageRequest {
  action: 'survey_created' | 'ai_call_used' | 'response_received';
  metadata?: {
    surveyId?: string;
    questionCount?: number;
    aiModel?: string;
  };
}

// GET /api/usage/analytics
interface UsageAnalyticsResponse {
  daily: Array<{
    date: string;
    surveys: number;
    responses: number;
    aiCalls: number;
  }>;
  monthly: {
    currentMonth: UsageStats;
    previousMonth: UsageStats;
  };
}
```

## å¯¦ä½œç­–ç•¥

### Phase 1: æ ¸å¿ƒè¨‚é–±é‚è¼¯

1. **å»ºç«‹è³‡æ–™æ¨¡å‹**ï¼šSubscription å’Œ UsageRecord Schema
2. **é™é¡æª¢æŸ¥æœå‹™**ï¼šSubscriptionService æ ¸å¿ƒé‚è¼¯
3. **æ¯æ—¥é‡ç½®æ©Ÿåˆ¶**ï¼šCron job å°åŒ—æ™‚é–“ 00:00 é‡ç½®
4. **åŸºç¤ API**ï¼šè¨‚é–±ç‹€æ…‹æŸ¥è©¢ã€ä½¿ç”¨é‡æª¢æŸ¥

### Phase 2: ä½¿ç”¨é‡è¿½è¹¤

1. **åŸ‹é»ç³»çµ±**ï¼šåœ¨é—œéµæ“ä½œé»åŠ å…¥ä½¿ç”¨é‡è¿½è¹¤
2. **å³æ™‚çµ±è¨ˆ**ï¼šRedis å¿«å–ç•¶æ—¥ä½¿ç”¨é‡
3. **åˆ†æä»‹é¢**ï¼šä½¿ç”¨é‡å„€è¡¨æ¿
4. **å‘Šè­¦æ©Ÿåˆ¶**ï¼šæ¥è¿‘é™é¡æ™‚æé†’ç”¨æˆ¶

### Phase 3: ä¼æ¥­åŠŸèƒ½

1. **å®¢è£½é…ç½®**ï¼šEnterprise å‹•æ…‹é™é¡èª¿æ•´
2. **å¤šç§Ÿæˆ¶æ”¯æ´**ï¼šåœ˜éšŠæˆå“¡ç®¡ç†
3. **è¨ˆè²»æ•´åˆ**ï¼šStripe ä»˜æ¬¾æµç¨‹
4. **é™„åŠ æœå‹™**ï¼šé¡åº¦åŠ è³¼ã€å°ˆæ¥­æ”¯æ´

## æ¸¬è©¦ç­–ç•¥

### 1. é–‹ç™¼ç’°å¢ƒé…ç½®

- **é è¨­æ–¹æ¡ˆ**ï¼šæ‰€æœ‰å¸³è™Ÿå»ºç«‹æ™‚è‡ªå‹•è¨­ç‚º Enterprise
- **ç„¡é™åˆ¶æ¨¡å¼**ï¼šç§»é™¤æ‰€æœ‰é™é¡æª¢æŸ¥ï¼ˆç’°å¢ƒè®Šæ•¸æ§åˆ¶ï¼‰
- **æ™‚é–“æ¨¡æ“¬**ï¼šå¯æ‰‹å‹•è§¸ç™¼æ¯æ—¥é‡ç½®é€²è¡Œæ¸¬è©¦

### 2. é™é¡æ¸¬è©¦å ´æ™¯

```typescript
// æ¸¬è©¦é…ç½®
const TEST_LIMITS = {
  enterprise: {
    dailySurveys: 100, // é«˜ä½†æœ‰é™çš„æ•¸å­—
    dailyAICalls: 1000, // ä¾¿æ–¼æ¸¬è©¦
    monthlyResponses: 999999, // å¯¦éš›ç„¡é™
    teamMembers: 999999, // å¯¦éš›ç„¡é™
  },
};
```

### 3. é‚Šç•Œæ¸¬è©¦

- æ¯æ—¥é™é¡é”åˆ°æ™‚çš„é˜»æ“‹è¡Œç‚º
- å°åŒ—æ™‚é–“ 00:00 é‡ç½®é‚è¼¯
- æœˆåº•æœˆåˆçš„è¨ˆè²»é€±æœŸåˆ‡æ›
- Enterprise å®¢è£½é™é¡èª¿æ•´

## ç›£æ§èˆ‡å‘Šè­¦

### 1. é—œéµæŒ‡æ¨™

- æ¯æ—¥æ´»èºç”¨æˆ¶æ•¸ï¼ˆDAUï¼‰
- å„æ–¹æ¡ˆä½¿ç”¨é‡åˆ†ä½ˆ
- é™é¡è§¸åŠç‡
- ä»˜è²»è½‰æ›ç‡

### 2. ç³»çµ±å¥åº·åº¦

- ä½¿ç”¨é‡è¿½è¹¤å»¶é²
- é™é¡æª¢æŸ¥éŸ¿æ‡‰æ™‚é–“
- æ¯æ—¥é‡ç½®ä»»å‹™æˆåŠŸç‡
- è¨ˆè²»ç³»çµ±åŒæ­¥ç‹€æ…‹

## æ“´å±•æ€§è€ƒé‡

### 1. é™„åŠ æœå‹™æ¶æ§‹

```typescript
interface AddonService {
  id: string;
  name: string;
  type: 'quota_boost' | 'feature_unlock' | 'support_tier';
  pricing: {
    model: 'per_unit' | 'flat_rate';
    amount: number;
  };
  limits?: {
    additionalSurveys?: number;
    additionalAICalls?: number;
  };
}

// ç¯„ä¾‹ï¼šå•å·é¡åº¦åŠ è³¼
const surveyBoostAddon: AddonService = {
  id: 'survey_boost_100',
  name: 'å•å·é¡åº¦åŠ è³¼åŒ…ï¼ˆ100ä»½ï¼‰',
  type: 'quota_boost',
  pricing: { model: 'per_unit', amount: 500 },
  limits: { additionalSurveys: 100 },
};
```

### 2. å¤šåœ°å€æ”¯æ´é å‚™

- æ™‚å€é…ç½®å½ˆæ€§åŒ–
- å¤šè²¨å¹£è¨ˆè²»æ”¯æ´
- åœ¨åœ°åŒ–é™é¡è¦å‰‡

### 3. API ç‰ˆæœ¬ç®¡ç†

- å‘å¾Œç›¸å®¹æ€§ä¿è­‰
- æ¼¸é€²å¼åŠŸèƒ½ç™¼å¸ƒ
- å®¢æˆ¶ç«¯ SDK æ›´æ–°ç­–ç•¥

## å®‰å…¨èˆ‡åˆè¦

### 1. è³‡æ–™ä¿è­·

- ä½¿ç”¨é‡è³‡æ–™åŠ å¯†å„²å­˜
- å€‹äººè­˜åˆ¥è³‡è¨Šæœ€å°åŒ–
- GDPR åˆè¦çš„è³‡æ–™ä¿ç•™æ”¿ç­–

### 2. è¨ˆè²»å®‰å…¨

- é˜²åˆ·é‡æ©Ÿåˆ¶
- ç•°å¸¸ä½¿ç”¨é‡æª¢æ¸¬
- ä»˜è²»é©—è­‰é›™é‡ç¢ºèª

## ç¸½çµ

æ­¤è¨‚é–±ç³»çµ±è¨­è¨ˆä»¥ç°¡æ½”æ€§å’Œå¯æ“´å±•æ€§ç‚ºæ ¸å¿ƒï¼Œé€šéæœˆä»˜è‡ªç„¶æœˆåˆ¶å’Œæ¯æ—¥é™é¡å¹³è¡¡ç”¨æˆ¶é«”é©—èˆ‡è³‡æºæ§åˆ¶ã€‚Enterprise ç­‰ç´šçš„å½ˆæ€§é…ç½®æ»¿è¶³ä¼æ¥­å®¢æˆ¶å¤šæ¨£åŒ–éœ€æ±‚ï¼Œè€Œå®Œæ•´çš„ç›£æ§å‘Šè­¦æ©Ÿåˆ¶ç¢ºä¿ç³»çµ±ç©©å®šæ€§ã€‚

æœªä¾†å¯é€šéé™„åŠ æœå‹™æ¨¡å¼å¯¦ç¾å•†æ¥­æ¨¡å¼å‰µæ–°ï¼Œä¸¦æ”¯æ´å¤šåœ°å€éƒ¨ç½²ä»¥æœå‹™å…¨çƒç”¨æˆ¶ã€‚
