# 2. ç”¨æˆ¶èªè­‰ç³»çµ±

## ğŸ“Š æ¦‚è¦½

- **éšæ®µ**: Phase 1
- **å„ªå…ˆç´š**: ğŸ”´ Critical
- **ç‹€æ…‹**: âœ… å·²å®Œæˆ
- **é ä¼°å·¥æ™‚**: 28h ï¼ˆåŸ 24h + 4h Nuxt3 åˆå§‹åŒ–ï¼‰
- **å¯¦éš›å·¥æ™‚**: 28h
- **é€²åº¦**: 100% â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
- **é–‹å§‹æ—¥æœŸ**: 2025-01-16
- **å®Œæˆæ—¥æœŸ**: 2025-01-18

## ğŸ”— ä¾è³´é—œä¿‚

- **å‰ç½®ä»»å‹™**: 1.åŸºç¤æ¶æ§‹è¨­ç½®ã€**0.Nuxt3 ä¸»æ‡‰ç”¨åˆå§‹åŒ–**ï¼ˆå¾…è£œå……ï¼‰
- **é˜»å¡ä»»å‹™**: 3.å•å·å»ºæ§‹å™¨, 4.è³‡æ–™æ”¶é›†ç³»çµ±
- **ç›¸é—œæ–‡ä»¶**:
  - [æ¥­å‹™é‚è¼¯è¦å‰‡](../../../smartsurvey-business-logic.md#è¨‚é–±æ–¹æ¡ˆèˆ‡é™åˆ¶)
  - [API åƒè€ƒæ‰‹å†Š](../../../smartsurvey-api-reference.md#èªè­‰-apis)
  - [è³‡æ–™åº«çµæ§‹](../../smartsurvey-db-structure.md#1-users-collection)

## ğŸ“š å­¸ç¿’ç›®æ¨™

- [x] ç†è§£ JWT èªè­‰æ©Ÿåˆ¶å’Œæœ€ä½³å¯¦è¸ âœ…
- [x] æŒæ¡å¯†ç¢¼åŠ å¯†å’Œå®‰å…¨æ€§è€ƒé‡ âœ…
- [x] å­¸æœƒ Nuxt3 ä¸­çš„ Session ç®¡ç† âœ…
- [x] ç†è§£è¨‚é–±æ–¹æ¡ˆå’Œä½¿ç”¨é™åˆ¶é‚è¼¯ âœ…
- [x] æŒæ¡ Zod è³‡æ–™é©—è­‰çš„å¯¦ä½œæ¨¡å¼ âœ…

## ğŸ—ï¸ ä»»å‹™åˆ†è§£

### 2.0 Nuxt3 ä¸»æ‡‰ç”¨åˆå§‹åŒ– [4h] âœ…

**ç‹€æ…‹**: âœ… **å„ªå…ˆç´š**: ğŸ”´ **å‰ç½®æ¢ä»¶**

#### 2.0.1 å»ºç«‹ Nuxt3 æ‡‰ç”¨

- **é ä¼°**: 2h | **å¯¦éš›**: 2h
- **ç‹€æ…‹**: âœ…
- **è² è²¬**: Claude + Human
- **å®Œæˆæ—¥æœŸ**: 2025-01-16

**ä»»å‹™èªªæ˜**: åœ¨ apps/web åˆå§‹åŒ– Nuxt3 æ‡‰ç”¨

**åŸ·è¡Œæ­¥é©Ÿ**:

```bash
# åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„åŸ·è¡Œ
cd apps
pnpm dlx nuxi@latest init web
cd web

# ä¿®æ”¹ package.json name ç‚º @smartsurvey/web
# å®‰è£å¿…è¦ä¾è³´
pnpm add @smartsurvey/shared
```

**é©—æ”¶æ¨™æº–**:

- [x] Nuxt3 æ‡‰ç”¨æˆåŠŸå»ºç«‹åœ¨ apps/web
- [x] å¯ä»¥åŸ·è¡Œ pnpm dev å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨
- [x] æ­£ç¢ºå¼•ç”¨ @smartsurvey/shared å¥—ä»¶

#### 2.0.2 é…ç½® Nuxt3 åŸºç¤è¨­å®š

- **é ä¼°**: 2h | **å¯¦éš›**: 2h
- **ç‹€æ…‹**: âœ…
- **è² è²¬**: Claude + Human
- **å®Œæˆæ—¥æœŸ**: 2025-01-16

**ä»»å‹™èªªæ˜**: è¨­å®š nuxt.config.ts å’ŒåŸºç¤çµæ§‹

**é…ç½®é …ç›®**:

- TypeScript è¨­å®š âœ…
- Nitro ä¼ºæœå™¨è¨­å®š âœ…
- ç’°å¢ƒè®Šæ•¸é…ç½® âœ…
- API è·¯ç”±çµæ§‹ âœ…
- Tailwind CSS æ•´åˆ âœ…
- Pinia ç‹€æ…‹ç®¡ç† âœ…
- å¥åº·æª¢æŸ¥ API âœ…

### 2.1 è³‡æ–™æ¨¡å‹è¨­è¨ˆ [6h] âœ…

**ç‹€æ…‹**: âœ… **å„ªå…ˆç´š**: ğŸ”´

#### 2.1.1 User Schema å®šç¾©

- **é ä¼°**: 3h | **å¯¦éš›**: 4h
- **ç‹€æ…‹**: âœ…
- **è² è²¬**: Claude + Human
- **å®Œæˆæ—¥æœŸ**: 2025-01-16

**ä»»å‹™èªªæ˜**: æ ¹æ“šæ¥­å‹™éœ€æ±‚è¨­è¨ˆ User è³‡æ–™çµæ§‹å’Œ Zod é©—è­‰

**å·²å®Œæˆå…§å®¹**:

âœ… å®Œæ•´çš„ TypeScript ä»‹é¢ç³»çµ±ï¼š

- `packages/shared/src/types/user.ts` - ç”¨æˆ¶ç›¸é—œæ‰€æœ‰é¡å‹
- `packages/shared/src/types/group.ts` - ç¾¤çµ„å’Œè¨‚é–±ç›¸é—œé¡å‹
- `packages/shared/src/types/permission.ts` - ABAC æ¬Šé™ç³»çµ±é¡å‹
- `packages/shared/src/types/invitation.ts` - é‚€è«‹ç³»çµ±é¡å‹
- `packages/shared/src/types/relationship.ts` - ç”¨æˆ¶ç¾¤çµ„è§’è‰²é—œè¯é¡å‹

âœ… å®Œæ•´çš„ Zod é©—è­‰ schemasï¼š

- `packages/shared/src/schemas/user.ts` - ç”¨æˆ¶é©—è­‰è¦å‰‡
- `packages/shared/src/schemas/group.ts` - ç¾¤çµ„é©—è­‰è¦å‰‡
- `packages/shared/src/schemas/permission.ts` - æ¬Šé™é©—è­‰è¦å‰‡
- `packages/shared/src/schemas/invitation.ts` - é‚€è«‹é©—è­‰è¦å‰‡
- `packages/shared/src/schemas/relationship.ts` - é—œè¯è¡¨é©—è­‰è¦å‰‡

âœ… ç³»çµ±å¸¸æ•¸å’Œé…ç½®ï¼š

- `packages/shared/src/constants/index.ts` - å®Œæ•´çš„ç³»çµ±å¸¸æ•¸å®šç¾©

**é©—æ”¶æ¨™æº–**:

- [x] User interface åŒ…å«æ‰€æœ‰å¿…è¦æ¬„ä½ (User, AuthUser, UserProfile ç­‰)
- [x] Zod schema å®šç¾©å®Œæ•´çš„é©—è­‰è¦å‰‡ (å«ä¸­æ–‡éŒ¯èª¤è¨Šæ¯)
- [x] å¯†ç¢¼ç›¸é—œæ¬„ä½æ­£ç¢ºè™•ç† (passwordHash, é‡è¨­ token ç­‰)
- [x] ä¼æ¥­ç´šå¤šç§Ÿæˆ¶ ABAC æ¬Šé™ç³»çµ±è¨­è¨ˆ
- [x] å®Œæ•´é‚€è«‹æµç¨‹å’Œæˆå“¡ç®¡ç†ç³»çµ±
- [x] è¨‚é–±æ–¹æ¡ˆé™åˆ¶å’ŒåŠŸèƒ½é–‹é—œè¨­è¨ˆ

#### 2.1.2 ç°¡åŒ–ç‰ˆè¨‚é–± Schema

- **é ä¼°**: 1h | **å¯¦éš›**: -
- **ç‹€æ…‹**: âœ… è¨­è¨ˆæ–‡ä»¶å·²å®Œæˆï¼ŒSchema å¾…å¯¦ä½œ
- **è² è²¬**: Claude + Human

**ä»»å‹™èªªæ˜**: Phase 1 å¯¦ä½œç°¡åŒ–ç‰ˆè¨‚é–±é‚è¼¯ï¼Œåƒ…æ”¯æ´æ–¹æ¡ˆé¡å‹åˆ†é¡ï¼Œç„¡è¤‡é›œè¨ˆè²»æ©Ÿåˆ¶

**å·²å®Œæˆ**:

- âœ… `docs/design/subscription-system.md` å®Œæ•´è¨­è¨ˆæ–‡ä»¶ï¼ˆä½œç‚º Phase 3 åƒè€ƒï¼‰

**å¾…å¯¦ä½œ**: ç°¡åŒ–ç‰ˆ Schema å®šç¾©

```typescript
// ğŸ”´ æ¶æ§‹ä¿®æ­£ï¼šè¨‚é–±ç¶å®šåœ¨ Groupï¼Œé User
interface Group {
  // ... å…¶ä»–æ¬„ä½
  subscriptionTier: 'free' | 'pro' | 'team' | 'enterprise';
  limits: GroupLimits;
  stats: GroupStats;
  // User é€éåŠ å…¥ Group ä¾†ç²å¾—è¨‚é–±æ¬Šç›Š
}
```

**Phase 1 ç¯„åœ**ï¼š

- Group-based è¨‚é–±æ–¹æ¡ˆåˆ†é¡
- åœ˜éšŠå±¤ç´šçš„é™åˆ¶æ§åˆ¶ï¼ˆå•å·æ•¸é‡ã€AI èª¿ç”¨æ¬¡æ•¸ï¼‰
- æ¸¬è©¦ç’°å¢ƒæ–°å»º Group é è¨­ Enterprise
- ç§»é™¤è¤‡é›œçš„è¨ˆè²»ã€ä½¿ç”¨é‡è¿½è¹¤

#### 2.1.3 Phase 1 MongoDB Collection çµæ§‹

- **é ä¼°**: 1h | **å¯¦éš›**: -
- **ç‹€æ…‹**: â¬œ
- **è² è²¬**: Claude + Human

**ä»»å‹™èªªæ˜**: æ›´æ–° MongoDB è³‡æ–™åº«è¨­è¨ˆï¼Œå°ˆæ³¨æ–¼ Phase 1 éœ€è¦çš„æ ¸å¿ƒ Collections

**èª¿æ•´ç¯„åœ**ï¼š

- âœ… ä¿ç•™ï¼šç”¨æˆ¶ç³»çµ± (users)
- âœ… ä¿ç•™ï¼šæ¬Šé™ç³»çµ±åŸºç¤ (groups, user_group_roles)
- âœ… ä¿ç•™ï¼šé‚€è«‹ç³»çµ± (invitations)
- âŒ **ç§»é™¤**ï¼šè¤‡é›œè¨‚é–±ç³»çµ± Collections (subscriptions, usage_records)
- âœ… **ç°¡åŒ–**ï¼šGroup Collection ä¸­æ•´åˆ subscriptionTier æ¬„ä½

**TODO**: éœ€è¦æ›´æ–° `docs/smartsurvey-db-structure.md`ï¼š

- Phase 1 å¿…è¦ Collections å®šç¾©
- ç°¡åŒ–ç‰ˆè¨‚é–±é‚è¼¯æ•´åˆåˆ° Group Collection
- åŸºç¤ç´¢å¼•ç­–ç•¥
- ç‚º Phase 3 é ç•™æ“´å±•ç©ºé–“

### 2.2 èªè­‰ API å¯¦ä½œ [12h] âœ…

**ç‹€æ…‹**: âœ… **å„ªå…ˆç´š**: ğŸ”´

#### 2.2.1 è¨»å†ŠåŠŸèƒ½

- **é ä¼°**: 4h | **å¯¦éš›**: 3h
- **ç‹€æ…‹**: âœ…
- **è² è²¬**: Claude + Human
- **å®Œæˆæ—¥æœŸ**: 2025-01-17

**ä»»å‹™èªªæ˜**: å¯¦ä½œç”¨æˆ¶è¨»å†Š APIï¼ŒåŒ…å«è³‡æ–™é©—è­‰å’Œå¯†ç¢¼åŠ å¯†

**å·²å®Œæˆå…§å®¹**:

- âœ… apps/web/server/api/auth/register.post.ts
- âœ… bcrypt å¯†ç¢¼åŠ å¯†è™•ç†
- âœ… email å”¯ä¸€æ€§æª¢æŸ¥
- âœ… Zod è³‡æ–™é©—è­‰
- âœ… éŒ¯èª¤è™•ç†å’Œå›æ‡‰

#### 2.2.2 ç™»å…¥åŠŸèƒ½

- **é ä¼°**: 3h | **å¯¦éš›**: 3h
- **ç‹€æ…‹**: âœ…
- **è² è²¬**: Claude + Human
- **å®Œæˆæ—¥æœŸ**: 2025-01-17

**ä»»å‹™èªªæ˜**: å¯¦ä½œç™»å…¥é©—è­‰å’Œ JWT Token ç”Ÿæˆ

**å·²å®Œæˆå…§å®¹**:

- âœ… apps/web/server/api/auth/login.post.ts
- âœ… å¯†ç¢¼é©—è­‰é‚è¼¯
- âœ… JWT Token ç”Ÿæˆ (Access + Refresh)
- âœ… ç”¨æˆ¶ç‹€æ…‹æª¢æŸ¥
- âœ… ç™»å…¥è¨˜éŒ„æ›´æ–°

#### 2.2.3 Token ç®¡ç†

- **é ä¼°**: 3h | **å¯¦éš›**: 4h
- **ç‹€æ…‹**: âœ…
- **è² è²¬**: Claude + Human
- **å®Œæˆæ—¥æœŸ**: 2025-01-18

**ä»»å‹™èªªæ˜**: å¯¦ä½œ JWT Token ç”Ÿæˆã€é©—è­‰å’Œåˆ·æ–°æ©Ÿåˆ¶

**å·²å®Œæˆå…§å®¹**:

- âœ… apps/web/server/utils/jwt.ts (å®Œæ•´ JWT å·¥å…·å‡½æ•¸)
- âœ… apps/web/server/api/auth/refresh.post.ts (Token åˆ·æ–°)
- âœ… apps/web/server/api/auth/me.get.ts (ç”¨æˆ¶è³‡è¨Šç²å–)
- âœ… å»¶é²å°å…¥å„ªåŒ–æ•ˆèƒ½

#### 2.2.4 ç™»å‡ºèˆ‡ Session æ¸…ç†

- **é ä¼°**: 2h | **å¯¦éš›**: 2h
- **ç‹€æ…‹**: âœ…
- **è² è²¬**: Claude + Human
- **å®Œæˆæ—¥æœŸ**: 2025-01-18

**å·²å®Œæˆå…§å®¹**:

- âœ… apps/web/server/api/auth/logout.post.ts
- âœ… Token é©—è­‰å’Œç™»å‡ºè¨˜éŒ„
- âœ… ç”¨æˆ¶æ´»å‹•æ™‚é–“æ›´æ–°
- âœ… é ç•™ Phase 2 Token é»‘åå–®æ©Ÿåˆ¶

### 2.3 èªè­‰ä¸­é–“ä»¶ [6h] âœ…

**ç‹€æ…‹**: âœ… **å„ªå…ˆç´š**: ğŸ”´

#### 2.3.1 JWT é©—è­‰ä¸­é–“ä»¶

- **é ä¼°**: 3h | **å¯¦éš›**: 3h
- **ç‹€æ…‹**: âœ…
- **è² è²¬**: Claude + Human
- **å®Œæˆæ—¥æœŸ**: 2025-01-17

**ä»»å‹™èªªæ˜**: å»ºç«‹ Nuxt3 èªè­‰ä¸­é–“ä»¶ï¼Œä¿è­·éœ€è¦ç™»å…¥çš„è·¯ç”±

**å·²å®Œæˆå…§å®¹**:

- âœ… apps/web/server/middleware/auth.ts
- âœ… JWT Token é©—è­‰é‚è¼¯
- âœ… è·¯å¾‘ç™½åå–®ç®¡ç†
- âœ… ç”¨æˆ¶è³‡è¨Šæ³¨å…¥ context
- âœ… Token å³å°‡éæœŸæé†’æ©Ÿåˆ¶

#### 2.3.2 æ¬Šé™æª¢æŸ¥ä¸­é–“ä»¶

- **é ä¼°**: 2h | **å¯¦éš›**: 2h
- **ç‹€æ…‹**: âœ…
- **è² è²¬**: Claude + Human
- **å®Œæˆæ—¥æœŸ**: 2025-01-17

**å·²å®Œæˆå…§å®¹**:

- âœ… requireAuth, getUser è¼”åŠ©å‡½æ•¸
- âœ… hasPermission åŸºç¤æ¬Šé™æª¢æŸ¥
- âœ… requireAdmin ç®¡ç†å“¡æ¬Šé™æª¢æŸ¥
- âœ… é ç•™ Phase 2 RBAC ç³»çµ±æ“´å±•

#### 2.3.3 è¨‚é–±é™åˆ¶ä¸­é–“ä»¶

- **é ä¼°**: 1h | **å¯¦éš›**: 1h
- **ç‹€æ…‹**: âœ… (Phase 1 åŸºç¤ç‰ˆæœ¬)
- **è² è²¬**: Claude + Human
- **å®Œæˆæ—¥æœŸ**: 2025-01-17

**ä»»å‹™èªªæ˜**: æª¢æŸ¥ç”¨æˆ¶è¨‚é–±æ–¹æ¡ˆé™åˆ¶

**å·²å®Œæˆå…§å®¹**:

- âœ… Phase 1 åŸºç¤æ¬Šé™æª¢æŸ¥æ©Ÿåˆ¶
- âœ… é ç•™è¨‚é–±æ–¹æ¡ˆé™åˆ¶æª¢æŸ¥æ¶æ§‹
- âœ… ç‚º Phase 2 è©³ç´°é™åˆ¶æ§åˆ¶é ç•™æ“´å±•

## ğŸ§ª æ¸¬è©¦è¨ˆåŠƒ

### å–®å…ƒæ¸¬è©¦

- [ ] User Schema é©—è­‰æ¸¬è©¦
- [ ] å¯†ç¢¼åŠ å¯†/é©—è­‰æ¸¬è©¦
- [ ] JWT Token ç”Ÿæˆ/é©—è­‰æ¸¬è©¦

### æ•´åˆæ¸¬è©¦

- [ ] è¨»å†Šæµç¨‹å®Œæ•´æ¸¬è©¦
- [ ] ç™»å…¥æµç¨‹å®Œæ•´æ¸¬è©¦
- [ ] èªè­‰ä¸­é–“ä»¶ä¿è­·æ¸¬è©¦

### å®‰å…¨æ¸¬è©¦

- [ ] SQL Injection é˜²è­·
- [ ] å¯†ç¢¼æš´åŠ›ç ´è§£é˜²è­·
- [ ] Token å®‰å…¨æ€§æ¸¬è©¦

## ğŸ“ API ç«¯é»æ¸…å–®

| Method | Endpoint                    | åŠŸèƒ½         | ç‹€æ…‹         |
| ------ | --------------------------- | ------------ | ------------ |
| POST   | `/api/auth/register`        | ç”¨æˆ¶è¨»å†Š     | âœ…           |
| POST   | `/api/auth/login`           | ç”¨æˆ¶ç™»å…¥     | âœ…           |
| POST   | `/api/auth/logout`          | ç”¨æˆ¶ç™»å‡º     | âœ…           |
| POST   | `/api/auth/refresh`         | Token åˆ·æ–°   | âœ…           |
| GET    | `/api/auth/me`              | ç²å–ç•¶å‰ç”¨æˆ¶ | âœ…           |
| POST   | `/api/auth/forgot-password` | å¿˜è¨˜å¯†ç¢¼     | â¬œ (Phase 2) |
| POST   | `/api/auth/reset-password`  | é‡è¨­å¯†ç¢¼     | â¬œ (Phase 2) |

## ğŸ’¡ å¯¦ä½œè¦é»

### å®‰å…¨è€ƒé‡

1. **å¯†ç¢¼å®‰å…¨**
   - ä½¿ç”¨ bcrypt é€²è¡Œå¯†ç¢¼ hash
   - æœ€å°‘ 8 å­—å…ƒï¼ŒåŒ…å«å¤§å°å¯«å­—æ¯å’Œæ•¸å­—
   - é¿å…å¸¸è¦‹å¯†ç¢¼

2. **Token å®‰å…¨**
   - JWT secret ä½¿ç”¨å¼·éš¨æ©Ÿå­—ä¸²
   - Access token çŸ­æœŸæœ‰æ•ˆï¼ˆ1å°æ™‚ï¼‰
   - Refresh token é•·æœŸæœ‰æ•ˆï¼ˆ7å¤©ï¼‰

3. **è³‡æ–™é©—è­‰**
   - å‰å¾Œç«¯éƒ½è¦é€²è¡Œè³‡æ–™é©—è­‰
   - ä½¿ç”¨ Zod schema ç¢ºä¿ä¸€è‡´æ€§
   - é©ç•¶çš„éŒ¯èª¤è¨Šæ¯å›å‚³

### æ•ˆèƒ½è€ƒé‡

- Redis å¿«å–ç”¨æˆ¶ session
- è³‡æ–™åº«æŸ¥è©¢å„ªåŒ–
- é¿å… N+1 æŸ¥è©¢å•é¡Œ

## ğŸ”„ ç‹€æ…‹è®Šæ›´æ­·å²

- 2025-01-13: ä»»å‹™å»ºç«‹ï¼Œç‹€æ…‹è¨­ç‚ºæœªé–‹å§‹
- 2025-01-16: é–‹å§‹åŸ·è¡Œï¼Œå®Œæˆ Nuxt3 ä¸»æ‡‰ç”¨åˆå§‹åŒ–ï¼ˆä»»å‹™ 2.0ï¼‰
- 2025-01-16: å®ŒæˆåŸºç¤ä»‹é¢å·¥ç¨‹ï¼ˆä»»å‹™ 2.1ï¼‰ï¼Œå»ºç«‹å®Œæ•´çš„ TypeScript é¡å‹ç³»çµ±å’Œ Zod é©—è­‰æ¶æ§‹
- 2025-01-17: å®Œæˆæ‰€æœ‰èªè­‰ API å¯¦ä½œï¼ˆä»»å‹™ 2.2ï¼‰å’Œèªè­‰ä¸­é–“ä»¶ï¼ˆä»»å‹™ 2.3ï¼‰
- 2025-01-18: å®Œæˆ refresh token æ©Ÿåˆ¶ï¼Œç”¨æˆ¶èªè­‰ç³»çµ± 100% å®Œæˆ

## ğŸ’¡ çµ¦ Claude çš„ä¸Šä¸‹æ–‡

**ä»»å‹™ä½ç½®**: Phase 1 > ç”¨æˆ¶èªè­‰ç³»çµ± **ç•¶å‰é€²åº¦**: âœ… 100% å®Œæˆ **æŠ€è¡“è¦é»**:
JWT + bcrypt + Zod + Nuxt3 middleware **å®‰å…¨è¦æ±‚**: éµå¾ª OWASP èªè­‰æœ€ä½³å¯¦è¸
**ç›¸é—œæª”æ¡ˆ**:

- `packages/shared/src/types/user.ts`
- `apps/web/server/api/auth/*.ts`
- `apps/web/middleware/auth.ts`
