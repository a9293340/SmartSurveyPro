# Auth API èªè­‰æœå‹™ç›®éŒ„

> ğŸ“ **ç›®éŒ„ä½œç”¨**ï¼šç”¨æˆ¶èªè­‰èˆ‡æˆæ¬Šç›¸é—œçš„ API ç«¯é»
>
> ğŸ“… **æœ€å¾Œæ›´æ–°**ï¼š2025-01-20
>
> ğŸ¯ **è² è²¬åŠŸèƒ½**ï¼šè™•ç†ç”¨æˆ¶è¨»å†Šã€ç™»å…¥ã€ç™»å‡ºã€Token ç®¡ç†ç­‰èªè­‰æµç¨‹

## ğŸ“‹ API ç«¯é»æ¸…å–®

| æª”æ¡ˆåç¨±           | HTTP æ–¹æ³• | è·¯ç”±                 | åŠŸèƒ½èªªæ˜     | ç‹€æ…‹      |
| ------------------ | --------- | -------------------- | ------------ | --------- |
| `register.post.ts` | POST      | `/api/auth/register` | ç”¨æˆ¶è¨»å†Š     | âœ… å·²å®Œæˆ |
| `login.post.ts`    | POST      | `/api/auth/login`    | ç”¨æˆ¶ç™»å…¥     | âœ… å·²å®Œæˆ |
| `logout.post.ts`   | POST      | `/api/auth/logout`   | ç”¨æˆ¶ç™»å‡º     | âœ… å·²å®Œæˆ |
| `me.get.ts`        | GET       | `/api/auth/me`       | ç²å–ç”¨æˆ¶è³‡è¨Š | âœ… å·²å®Œæˆ |
| `refresh.post.ts`  | POST      | `/api/auth/refresh`  | åˆ·æ–° Token   | âœ… å·²å®Œæˆ |

## ğŸ”§ è©³ç´° API èªªæ˜

### 1. POST /api/auth/register

**åŠŸèƒ½**ï¼šæ–°ç”¨æˆ¶è¨»å†Š **è«‹æ±‚é«”**ï¼š

```typescript
{
  email: string; // ç”¨æˆ¶ Emailï¼ˆå¿…å¡«ï¼‰
  password: string; // å¯†ç¢¼ï¼ˆå¿…å¡«ï¼‰
  name: string; // ç”¨æˆ¶åç¨±ï¼ˆå¿…å¡«ï¼‰
}
```

**å›æ‡‰**ï¼š

```typescript
{
  success: true;
  data: {
    user: AuthUser; // ç”¨æˆ¶åŸºæœ¬è³‡è¨Š
    tokens: {
      accessToken: string;
      refreshToken: string;
    }
  }
}
```

**æ¥­å‹™é‚è¼¯**ï¼š

1. é©—è­‰ Email æ ¼å¼å’Œå”¯ä¸€æ€§
2. å¯†ç¢¼åŠ å¯†å­˜å„²
3. å»ºç«‹é è¨­ç¾¤çµ„
4. ç”Ÿæˆ JWT Token å°
5. è¨˜éŒ„è¨»å†Šæ´»å‹•

### 2. POST /api/auth/login

**åŠŸèƒ½**ï¼šç”¨æˆ¶ç™»å…¥é©—è­‰ **è«‹æ±‚é«”**ï¼š

```typescript
{
  email: string; // ç™»å…¥ Email
  password: string; // ç™»å…¥å¯†ç¢¼
}
```

**å›æ‡‰**ï¼šåŒè¨»å†Š API **æ¥­å‹™é‚è¼¯**ï¼š

1. é©—è­‰ç”¨æˆ¶å­˜åœ¨æ€§
2. å¯†ç¢¼æ¯”å°é©—è­‰
3. æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹ï¼ˆå°ç¦ã€å‡çµç­‰ï¼‰
4. ç”Ÿæˆæ–°çš„ Token å°
5. è¨˜éŒ„ç™»å…¥æ´»å‹•å’Œ IP

### 3. POST /api/auth/logout

**åŠŸèƒ½**ï¼šç”¨æˆ¶ç™»å‡º **è«‹æ±‚**ï¼šéœ€è¦ Authorization Header **å›æ‡‰**ï¼š

```typescript
{
  success: true;
  message: 'ç™»å‡ºæˆåŠŸ';
}
```

**æ¥­å‹™é‚è¼¯**ï¼š

1. é©—è­‰ JWT Token æœ‰æ•ˆæ€§
2. è¨˜éŒ„ç™»å‡ºæ´»å‹•
3. _ï¼ˆæœªä¾†ï¼‰åŠ å…¥ Token é»‘åå–®_

### 4. GET /api/auth/me

**åŠŸèƒ½**ï¼šç²å–ç•¶å‰ç”¨æˆ¶å®Œæ•´è³‡è¨Š **è«‹æ±‚**ï¼šéœ€è¦ Authorization Header **å›æ‡‰**ï¼š

```typescript
{
  success: true;
  data: {
    user: User;           // å®Œæ•´ç”¨æˆ¶è³‡è¨Š
    groups: Group[];      // ç”¨æˆ¶æ‰€å±¬ç¾¤çµ„
    permissions: string[]; // ç”¨æˆ¶æ¬Šé™åˆ—è¡¨
  };
}
```

**æ¥­å‹™é‚è¼¯**ï¼š

1. é©—è­‰ JWT Token
2. æŸ¥è©¢ç”¨æˆ¶å®Œæ•´è³‡æ–™
3. æŸ¥è©¢ç”¨æˆ¶ç¾¤çµ„é—œä¿‚
4. è¨ˆç®—æœ‰æ•ˆæ¬Šé™é›†åˆ

### 5. POST /api/auth/refresh

**åŠŸèƒ½**ï¼šä½¿ç”¨ Refresh Token æ›å–æ–°çš„ Access Token **è«‹æ±‚é«”**ï¼š

```typescript
{
  refreshToken: string;
}
```

**å›æ‡‰**ï¼š

```typescript
{
  success: true;
  data: {
    accessToken: string; // æ–°çš„ Access Token
    refreshToken: string; // æ–°çš„ Refresh Tokenï¼ˆå¯é¸ï¼‰
  }
}
```

**æ¥­å‹™é‚è¼¯**ï¼š

1. é©—è­‰ Refresh Token æœ‰æ•ˆæ€§
2. æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹
3. ç”Ÿæˆæ–°çš„ Access Token
4. _ï¼ˆæœªä¾†ï¼‰Token é»‘åå–®æª¢æŸ¥_

## ğŸ” å®‰å…¨æ©Ÿåˆ¶

### JWT Token è¨­è¨ˆ

```typescript
// Access Token (çŸ­æœŸæœ‰æ•ˆï¼Œ15-30åˆ†é˜)
{
  userId: string;
  email: string;
  exp: number; // éæœŸæ™‚é–“
  iat: number; // ç°½ç™¼æ™‚é–“
}

// Refresh Token (é•·æœŸæœ‰æ•ˆï¼Œ7-30å¤©)
{
  userId: string;
  tokenId: string; // Token å”¯ä¸€æ¨™è­˜
  exp: number;
}
```

### å¯†ç¢¼å®‰å…¨

- ä½¿ç”¨ bcrypt é€²è¡Œå¯†ç¢¼å“ˆå¸Œ
- é è¨­ 10 è¼ª Salt rounds
- å¯†ç¢¼å¼·åº¦é©—è­‰ï¼ˆå‰ç«¯ + å¾Œç«¯ï¼‰

### å®‰å…¨æ¨™é ­

```typescript
// CORS è¨­å®š
{
  origin: process.env.ALLOWED_ORIGINS,
  credentials: true
}

// å®‰å…¨éŸ¿æ‡‰æ¨™é ­
{
  'X-Content-Type-Options': 'nosniff',
  'X-Frame-Options': 'DENY',
  'X-XSS-Protection': '1; mode=block'
}
```

## ğŸ“Š éŒ¯èª¤è™•ç†

### æ¨™æº–éŒ¯èª¤å›æ‡‰

```typescript
{
  success: false;
  statusCode: number;
  statusMessage: string;
  data?: {
    field?: string;      // é©—è­‰éŒ¯èª¤çš„æ¬„ä½
    details?: any;       // é¡å¤–éŒ¯èª¤è³‡è¨Š
  };
}
```

### å¸¸è¦‹éŒ¯èª¤ç¢¼

| ç‹€æ…‹ç¢¼ | éŒ¯èª¤æƒ…å¢ƒ         | è™•ç†å»ºè­°                   |
| ------ | ---------------- | -------------------------- |
| 400    | è«‹æ±‚è³‡æ–™æ ¼å¼éŒ¯èª¤ | æª¢æŸ¥å‰ç«¯é©—è­‰é‚è¼¯           |
| 401    | Token ç„¡æ•ˆæˆ–éæœŸ | å¼•å°ç”¨æˆ¶é‡æ–°ç™»å…¥           |
| 403    | æ¬Šé™ä¸è¶³         | é¡¯ç¤ºæ¬Šé™éŒ¯èª¤è¨Šæ¯           |
| 409    | Email å·²å­˜åœ¨     | æç¤ºç”¨æˆ¶ä½¿ç”¨å…¶ä»– Email     |
| 429    | è«‹æ±‚éæ–¼é »ç¹     | å¯¦ä½œå‰ç«¯é™æµæ©Ÿåˆ¶           |
| 500    | ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤   | è¨˜éŒ„éŒ¯èª¤æ—¥èªŒï¼Œé¡¯ç¤ºé€šç”¨éŒ¯èª¤ |

## ğŸ”„ è³‡æ–™åº«æ“ä½œ

### ä¸»è¦ Collections

- **users**: ç”¨æˆ¶åŸºæœ¬è³‡æ–™
- **groups**: ç”¨æˆ¶ç¾¤çµ„è³‡æ–™
- **user_groups**: ç”¨æˆ¶ç¾¤çµ„é—œä¿‚è¡¨
- **activity_logs**: ç”¨æˆ¶æ´»å‹•è¨˜éŒ„

### ç´¢å¼•è¨­è¨ˆ

```javascript
// users collection
db.users.createIndex({ email: 1 }, { unique: true });
db.users.createIndex({ status: 1 });

// activity_logs collection
db.activity_logs.createIndex({ userId: 1, createdAt: -1 });
db.activity_logs.createIndex({ createdAt: 1 }, { expireAfterSeconds: 7776000 }); // 90å¤©éæœŸ
```

## ğŸš€ æ•ˆèƒ½è€ƒé‡

### å¿«å–ç­–ç•¥

```typescript
// Redis å¿«å–è¨­è¨ˆï¼ˆæœªä¾†å¯¦ä½œï¼‰
{
  `user:${userId}`: "ç”¨æˆ¶åŸºæœ¬è³‡æ–™å¿«å–",
  `user:permissions:${userId}`: "ç”¨æˆ¶æ¬Šé™å¿«å–",
  `blacklist:${tokenId}`: "Token é»‘åå–®",
}
```

### è³‡æ–™åº«å„ªåŒ–

- ç”¨æˆ¶æŸ¥è©¢ä½¿ç”¨ email ç´¢å¼•
- æ´»å‹•æ—¥èªŒè‡ªå‹•éæœŸæ©Ÿåˆ¶
- ç¾¤çµ„æ¬Šé™æŸ¥è©¢ä½¿ç”¨èšåˆç®¡é“

## ğŸ“ Phase 2 å¾…å¯¦ä½œåŠŸèƒ½

### é«˜ç´šå®‰å…¨åŠŸèƒ½

- [ ] Token é»‘åå–®æ©Ÿåˆ¶ï¼ˆRedisï¼‰
- [ ] ç™»å…¥å¤±æ•—é™åˆ¶å’Œå¸³è™Ÿé–å®š
- [ ] å¤šè¨­å‚™ç®¡ç†å’Œå¼·åˆ¶ç™»å‡º
- [ ] å¯ç–‘æ´»å‹•æª¢æ¸¬

### ç¤¾äº¤ç™»å…¥

- [ ] Google OAuth æ•´åˆ
- [ ] GitHub OAuth æ•´åˆ
- [ ] ç¬¬ä¸‰æ–¹å¸³è™Ÿç¶å®š

### é€²éšåŠŸèƒ½

- [ ] å…©æ­¥é©Ÿé©—è­‰ï¼ˆ2FAï¼‰
- [ ] å¯†ç¢¼é‡ç½®æµç¨‹
- [ ] Email é©—è­‰æ©Ÿåˆ¶
- [ ] æœƒè©±ç®¡ç†ç•Œé¢

## ğŸ§ª æ¸¬è©¦ç­–ç•¥

### å–®å…ƒæ¸¬è©¦é‡é»

- [ ] å¯†ç¢¼åŠ å¯†å’Œé©—è­‰é‚è¼¯
- [ ] JWT Token ç”Ÿæˆå’Œé©—è­‰
- [ ] è«‹æ±‚åƒæ•¸é©—è­‰é‚è¼¯
- [ ] éŒ¯èª¤è™•ç†å®Œæ•´æ€§

### æ•´åˆæ¸¬è©¦é‡é»

- [ ] å®Œæ•´èªè­‰æµç¨‹
- [ ] Token éæœŸå’Œåˆ·æ–°æµç¨‹
- [ ] éŒ¯èª¤å ´æ™¯è™•ç†
- [ ] ä½µç™¼è«‹æ±‚è™•ç†

### å®‰å…¨æ¸¬è©¦é‡é»

- [ ] SQL/NoSQL æ³¨å…¥æ¸¬è©¦
- [ ] æš´åŠ›ç ´è§£é˜²è­·æ¸¬è©¦
- [ ] JWT Token å®‰å…¨æ€§æ¸¬è©¦
- [ ] æ•æ„Ÿè³‡æ–™æ´©æ¼æª¢æŸ¥

---

**æœ€å¾Œæ›´æ–°è€…**ï¼šClaude AI Assistant **ä¸‹æ¬¡æª¢æŸ¥**ï¼šå¯¦ä½œ Phase 2 åŠŸèƒ½æ™‚
